<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Phresh</title>
  <meta name="comp1800 boilerplate code" content="my bcit project" />
  <meta name="author" content="BCIT" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous" />
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.css" />
  <link href="styles/login.css" rel="stylesheet" />
  <link href="styles/template.css" rel="stylesheet" />

</head>

<body>
  <nav class="navbar">
    <div class="container-fluid">
      <div id="logo">
        <img src="images/logo.png" alt="logo" />
      </div>
      <h1 class="ms-4 me-auto">Phresh</h1>
    </div>
  </nav>

  <div class="container">
    <h1>Welcome !</h1>
    <p>Let's get you logged in ...</p>
  </div>

  <div id="firebaseui-auth-container" class="container-fluid text-center mt-5"></div>
  <div id="loader">Loading...</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
    crossorigin="anonymous"></script>

  <script src="https://kit.fontawesome.com/26da0e4274.js" crossorigin="anonymous"></script>

  <script src="https://www.gstatic.com/firebasejs/8.3.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.3.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.3.0/firebase-firestore.js"></script>

  <script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>

  <script src="scripts/firebase_api_phresh.js"></script>

  <script>
    // Initialize the FirebaseUI Widget using Firebase.
    var ui = new firebaseui.auth.AuthUI(firebase.auth());
    var uiConfig = {
      callbacks: {
        signInSuccessWithAuthResult: function (authResult, redirectUrl) {
          // User successfully signed in.
          // Return type determines whether we continue the redirect automatically or whether we leave that to developer to handle.
          //------------------------------------------------------------------------------------------
          var user = authResult.user;
          var timeStamp = Date.now();
          var preferences = [];
          preferences.push("fastfood");
          preferences.push("asianfood");
          preferences.push("americanfood");
          preferences.push("seafood");
          preferences.push("vegetarian");

          if (authResult.additionalUserInfo.isNewUser) {
            // if the user is new, we create a new user in our collection.
            db.collection("users")
              .doc(user.uid)
              // write data to firestore
              .set({
                // we assign this user with the name and email provided to our "users" collection 
                name: user.displayName,
                email: user.email,
                // the time stamp of the sign up is used to create a unique group code for the user
                groupCode: timeStamp,
                // default preferences is to check all options
                "preferences": preferences
              })
              .then(function () {
                db.collection("rooms").doc(timeStamp + "").collection("votes").add({

                })
                // change this!
                console.log("New user added to firestore");
                db.collection("rooms").doc(timeStamp + "").set({
                  1: 0,
                  2: 0,
                  3: 0,
                  4: 0,
                  5: 0
                })
              })
              .then(function () {
                window.location.assign("main.html"); //re-direct to main.html after signup
              })
              .catch(function (error) {
                console.log("Error adding new user: " + error);
              });
          } else {
            return true;
          }
          return false;
        },

        uiShown: function () {
          // The widget is rendered.
          // Hide the loader.
          document.getElementById("loader").style.display = "none";
        },
      },

      // Will use popup for IDP Providers sign-in flow instead of the default, redirect.
      signInFlow: "popup",
      signInSuccessUrl: "main.html",
      signInOptions: [
        firebase.auth.EmailAuthProvider.PROVIDER_ID,
      ],

      // Terms of service url.
      tosUrl: "<your-tos-url>",
      // Privacy policy url.
      privacyPolicyUrl: "<your-privacy-policy-url>",
    };

    // The start method will wait until the DOM is loaded.
    ui.start("#firebaseui-auth-container", uiConfig);
  </script>
</body>

</html>